##第十一课：Spring Data JPA 的配置之 SpringBoot 2.0 加载详解
###11.1 Spring Boot autoconfigure介绍
这章节，我们简单的介绍一下Spring Boot都在帮我们做些什么事情。我看一下下面这个图对SpringBoot做整体认识：
![enter image description here](http://images.gitbook.cn/3d4fdb50-4603-11e8-88ee-fb64bbe1a046) 
其实老师这里给同学们介绍一个学习方法，就是学习任何东西之前都要对整体有个认识，然后知道你的知识点处于什么位置。正如图上所示，Spring Boot 核心的五大功能：
#### 11.1.1 Spring Boot帮我们封装的Autoconfigure，帮我们实现自动加载配置文件的核心能力。我们所有的Spring Boot项目一开始就会引用`@SpringBootApplication`注解，而我们查看其源码：
````
package org.springframework.boot.autoconfigure;
@Target({ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Documented
@Inherited
@SpringBootConfiguration
@EnableAutoConfiguration
@ComponentScan(
    excludeFilters = {@Filter(
    type = FilterType.CUSTOM,
    classes = {TypeExcludeFilter.class}
), @Filter(
    type = FilterType.CUSTOM,
    classes = {AutoConfigurationExcludeFilter.class}
)}
)
public @interface SpringBootApplication {
    @AliasFor(
        annotation = EnableAutoConfiguration.class
    )
    Class<?>[] exclude() default {};
    @AliasFor(
        annotation = EnableAutoConfiguration.class
    )
    String[] excludeName() default {};
    @AliasFor(
        annotation = ComponentScan.class,
        attribute = "basePackages"
    )
    String[] scanBasePackages() default {};
    @AliasFor(
        annotation = ComponentScan.class,
        attribute = "basePackageClasses"
    )
    Class<?>[] scanBasePackageClasses() default {};
}
````    
其就是Spring Boot 的核心能力自动加载扫描包的能力。其中自动装配了`@EnableAutoConfiguration`，通过`@EnableAutoConfiguration`启用Spring应用程序上下文的自动配置，这个注解会导入一个`EnableAutoConfigurationImportSelector`的类,而这个类会去读取一个`spring.factories`下key为`EnableAutoConfiguration`对应的全限定名的值。    

这个spring.factories里面配置的那些类，主要作用是告诉Spring Boot这个stareter所需要加载的那些xxxAutoConfiguration类，也就是你真正的要自动注册的那些bean或功能。然后，我们实现一个spring.factories指定的类，标上@Configuration注解，一个starter就定义完了。 

***SpringBoot中的META-INF/spring.factories***（完整路径：spring-boot/spring-boot-autoconfigure/src/main/resources/META-INF/spring.factories）中关于EnableAutoConfiguration的这段配置如下 ：

````
org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\
org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\
org.springframework.boot.autoconfigure.data.jpa.JpaRepositoriesAutoConfiguration,\
org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration,\
````
我们可以发现`JpaRepositoriesAutoConfiguration和HibernateJpaAutoConfiguration`帮我们装置了JPA相关的配置。
#### 11.1.2 Starter
Spring boot中的starter概念是非常重要的机制，能够抛弃以前繁杂的配置，统一集成进starter，应用者只需要引入starter jar包，spring boot就能自动扫描到要加载的信息。   非常重要的两点：

1. starter让我们摆脱了各种依赖库的处理，N多项目的jar依赖配置等都不需要我们关心，也不需要配置装载Bean等帮我们摆脱各种信息的困扰。
2. Spring Boot会自动通过classpath路径下的类发现需要的Bean，并织入bean。    

就像我们前面讲过的，如果你想使用Spring和用JPA访问数据库，你只要依赖 spring-boot-starter-data-jpa 即可。     
#### 11.1.3 spring-boot-actuator
提供SpringBoot应用的外围支撑性功能。 比如：

1. Endpoints，SpringBoot应用状态监控管理
1. HealthIndicator，SpringBoot应用健康指示表
1. 提供metrics支持
1. 提供远程shell支持 

就是帮我们提供了各种监控指标，默认的访问连接如下：
![enter image description here](http://images.gitbook.cn/a4261f30-4606-11e8-981a-4183f6e5c19e)
#### 11.1.4 spring-boot-tools
提供了SpringBoot开发者的常用工具集。诸如，spring-boot-gradle-plugin，spring-boot-maven-plugin，就是这个工程里面的
#### 11.1.5 spring-boot-cli
是Spring Boot命令行交互工具，可用于使用Spring进行快速原型搭建。你可以用它直接运行Groovy脚本。如果你不喜欢Maven或Gradle，Spring提供了CLI（Command Line Interface）来开发运行Spring应用程序。你可以使用它来运行Groovy脚本，甚至编写自定义命令。

### 11.2 Spring Data JPA都有哪些扩展配置
#### 11.2.1 传统的XML的配置方法
我们要集成Spring Data Jpa，在没有引用Spring Boot的时候我们通常的做法是：
***1）XML配置***

````
<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns:beans="http://www.springframework.org/schema/beans"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns="http://www.springframework.org/schema/data/jpa"
  xsi:schemaLocation="http://www.springframework.org/schema/beans
    http://www.springframework.org/schema/beans/spring-beans.xsd
    http://www.springframework.org/schema/data/jpa
    http://www.springframework.org/schema/data/jpa/spring-jpa.xsd">
  <repositories base-package="com.acme.repositories" />
</beans:beans>
````
Spring data 通过repositories 标签,允许你简单地定义一个基本方案。      
Spring是扫描 com.acme.repositories 和所有的子包接口扩展 Repository 或其sub-interfaces之一。 对于发现的每个接口,注册持久性特定于技术的基础设施 FactoryBean 创建合适的代理,处理调用查询的方法。      
每个bean注册在bean名称来源于接口名称,所以一个接口 UserRepository 将注册下 userRepository 。 的 base-package 属性允许通配符,您可以定义一个模式扫描包。
   
***2) 使用过滤器***
您可能希望更细粒度的控制接口获得创建bean实例。 要做到这一点,你使用 `< include-filter / > 和 <exclude-filter /> 元素内 <repositories /> `。 元素的语义是完全等价的Spring’s 上下文名称空间。
要排除某些接口从实例库中,您可以使用以下配置:

````
<repositories base-package="com.acme.repositories">
  <context:exclude-filter type="regex" expression=".*SomeRepository" />
</repositories>
````

#### 11.2.2 @EnableJpaRepositories详解

***1)基于JavaConfig，基于注解的存储库配置示例***

````
@Configuration
@EnableJpaRepositories("com.acme.repositories")
class ApplicationConfiguration {
}
````
***2）@EnableJpaRepositories加载时机：***
通过我们前面讲的，当我们引用SpringBoot之后，添加@SpringBootApplication什么都不需要做就自动加载了。正向我们前面讲的我们查看其源码，找到spring.factories默认加载了org.springframework.boot.autoconfigure.data.jpa.JpaRepositoriesAutoConfiguration，查看JpaRepositoriesAutoConfiguration源码：
````
class JpaRepositoriesAutoConfigureRegistrar extends AbstractRepositoryConfigurationSourceSupport {
    JpaRepositoriesAutoConfigureRegistrar() {
    }
    @EnableJpaRepositories
    private static class EnableJpaRepositoriesConfiguration {
        private EnableJpaRepositoriesConfiguration() {
        }
    }
}
````
发现其里面帮我们加载了@EnableJpaRepositories。当然了我们也可以在我们的javaconfig里面直接配置@EnableJpaRepositories覆盖默认配置。
#### 11.2.3 @EnableJpaRepositories详解

````
@Import(JpaRepositoriesRegistrar.class)
public @interface EnableJpaRepositories {
   String[] value() default {};
   String[] basePackages() default {};
   Class<?>[] basePackageClasses() default {};
   Filter[] includeFilters() default {};
   Filter[] excludeFilters() default {};
   String repositoryImplementationPostfix() default "Impl";
   String namedQueriesLocation() default "";
   Key queryLookupStrategy() default Key.CREATE_IF_NOT_FOUND;
   Class<?> repositoryFactoryBeanClass() default JpaRepositoryFactoryBean.class;
   Class<?> repositoryBaseClass() default DefaultRepositoryBaseClass.class;
   String entityManagerFactoryRef() default "entityManagerFactory";
   String transactionManagerRef() default "transactionManager";
   boolean considerNestedRepositories() default false;
   boolean enableDefaultTransactions() default true;
}
````

***1）value等于basePackage***

用于配置扫描Repositories所在的package及子package。简单配置中的配置则等同于此项配置值，basePackages可以配置为单个字符串，也可以配置为字符串数组形式。

````
@EnableJpaRepositories(basePackages = "com.jack")
@EnableJpaRepositories(
basePackages = {"com.jack.sample.repository", 			  "com.jack.tower.repository"})
````
***2）basePackageClasses 指定 Repository所在包的类***

````
@EnableJpaRepositories(basePackageClasses = BookRepository.class)
@EnableJpaRepositories(basePackageClasses = {ShopRepository.class, OrganizationRepository.class})
````
备注：测试的时候发现，配置包类的一个Repositories类，该包内其他Repositores也会被加。

***3）includeFilters***
 
包含过滤器，该过滤区采用ComponentScan的过滤器类，哪些包含在内。

````
@EnableJpaRepositories( includeFilters={@ComponentScan.Filter(type=FilterType.ANNOTATION, value=Repository.class)})
````

***4）excludeFilters*** 
不包含过滤器，该过滤区采用ComponentScan的过滤器类，哪些不包含在内。

````
@EnableJpaRepositories(
         excludeFilters={
                 @ComponentScan.Filter(type=FilterType.ANNOTATION, value=Service.class),
                 @ComponentScan.Filter(type=FilterType.ANNOTATION, value=Controller.class)})
````
> 注意：实际使用场景：1,2,3,4等我们DATA部分不止有关系数据库的时候，当我们MongoDB或者Redis或者关系数据库JPA混合使用的时候，就会用到前面4种方式，来指定不同的package用不同的Spring Data 的实现。

***5）repositoryImplementationPostfix 实现类的默认尾部结束字符。***

````
@EnableJpaRepositories(value="com.jackzhang.example.quickstart.repository",repositoryImplementationPostfix="Impl")默认"Impl"结尾。比如：ShopRepository，对应的为ShopRepositoryImpl
````

***6）namedQueriesLocation***
当我们用原始sql的时候：named SQL存放的位置，默认为META-INF/jpa-named-queries.properties
内容如下：

````
Todo.findBySearchTermNamedFile=SELECT t FROM Table t WHERE LOWER(t.description) LIKE LOWER(CONCAT('%', :searchTerm, '%')) ORDER BY t.title ASC
````

***7）queryLookupStrategy***

构建条件查询的策略，包含三种方式CREATE，USE_DECLARED_QUERY，CREATE_IF_NOT_FOUND：
 
  1. CREATE：按照接口名称自动构建查询
  1. USE_DECLARED_QUERY：用户声明查询
  1. CREATE_IF_NOT_FOUND：先搜索用户声明的，不存在则自动构建
该策略针对如下通过接口名称自动生成查询的场景

***8）repositoryFactoryBeanClass***

指定Repository的工厂类

***9) entityManagerFactoryRef***
实体管理工厂引用名称，对应到@Bean注解对应的方法

````
@Bean
 public LocalContainerEntityManagerFactoryBean entityManagerFactory() {
         LocalContainerEntityManagerFactoryBean entityManagerFactoryBean = new LocalContainerEntityManagerFactoryBean();
    ...
         return entityManagerFactoryBean;
}
````

***10) transactionManagerRef***
事务管理工厂引用名称，对应到@Bean注解对应的方法

````
@Bean
public JpaTransactionManager transactionManager() {
JpaTransactionManager transactionManager = new JpaTransactionManager();
transactionManager.setEntityManagerFactory(entityManagerFactory().getObject());
return transactionManager;
}
````

### 11.3 JpaRepositoriesAutoConfiguration关键源码解析
我们再来回头看一下关键源码以做到心中有数：

````
@Configuration
@ConditionalOnBean(DataSource.class)
@ConditionalOnClass(JpaRepository.class)
@ConditionalOnMissingBean({ JpaRepositoryFactoryBean.class,
      JpaRepositoryConfigExtension.class })
@ConditionalOnProperty(prefix = "spring.data.jpa.repositories", name = "enabled", havingValue = "true", matchIfMissing = true)
@Import(JpaRepositoriesAutoConfigureRegistrar.class)
@AutoConfigureAfter(HibernateJpaAutoConfiguration.class)
public class JpaRepositoriesAutoConfiguration {
....
}
````
通过源码发现此类加载了HibernateJpaAutoConfiguration开启了JPA的默认配置文件源码如下：

````
@Configuration
@ConditionalOnClass({ LocalContainerEntityManagerFactoryBean.class, EntityManager.class })
@Conditional(HibernateEntityManagerCondition.class)
@AutoConfigureAfter({ DataSourceAutoConfiguration.class })
public class HibernateJpaAutoConfiguration extends JpaBaseConfiguration {
......}
````
还有类JpaRepositoriesAutoConfigureRegistrar开启了@EnableJpaRepositories源码如下：

````
class JpaRepositoriesAutoConfigureRegistrar
      extends AbstractRepositoryConfigurationSourceSupport {
   @Override
   protected Class<? extends Annotation> getAnnotation() {
      return EnableJpaRepositories.class;
   }
   @EnableJpaRepositories
   private static class EnableJpaRepositoriesConfiguration {
   }
......
}
````
类关系图：
![enter image description here](http://images.gitbook.cn/a467ad50-460c-11e8-a222-fb7d71af208a)
后面的DataSource部分我们还会详细讲。




