
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>09：Auditing与@version                     · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="10.html" />
    
    
    <link rel="prev" href="08.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    《Spring Data JPA实战》
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="01.html">
            
                <a href="01.html">
            
                    
                    01：整体认识JPA
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="02.html">
            
                <a href="02.html">
            
                    
                    02：Jpa基础查询方法JpaRepository详解        
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="03.html">
            
                <a href="03.html">
            
                    
                    03：定义查询方法(Defining Query Methods    
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="04.html">
            
                <a href="04.html">
            
                    
                    04：注解式查询方法    
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="05.html">
            
                <a href="05.html">
            
                    
                    05：@Entity实例里面常用注解详解            
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6" data-path="06.html">
            
                <a href="06.html">
            
                    
                    06：JpaRepository扩展之QueryByExampleExecutor
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7" data-path="07.html">
            
                <a href="07.html">
            
                    
                    07：JpaRepository扩展之JpaSpecificationExecutor
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.8" data-path="08.html">
            
                <a href="08.html">
            
                    
                    08 :  JpaRepository扩展之自定义Repositor    
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2.9" data-path="09.html">
            
                <a href="09.html">
            
                    
                    09：Auditing与@version                    
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.10" data-path="10.html">
            
                <a href="10.html">
            
                    
                    10：对MvcWeb的支持分页和排序的支持            
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.11" data-path="11.html">
            
                <a href="11.html">
            
                    
                    11：Spring Data Jpa的配置之SpringBoot2.0加载详解
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.12" data-path="12.html">
            
                <a href="12.html">
            
                    
                    12：DataSource的配置与事务详解、多数据源        
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.13" data-path="13.html">
            
                <a href="13.html">
            
                    
                    13：Spring Data Jpa之QueryDSL支持    
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    Spring DATA JPA 扩展阅读
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../SpringDataJpa高级用法补充/SpringDataJPA的一些高级用法扩展.html">
            
                <a href="../SpringDataJpa高级用法补充/SpringDataJPA的一些高级用法扩展.html">
            
                    
                    Spring Data JPA 晋级提升篇：复杂场景实战用法与优化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../SpringDataJpa高级用法补充/SpringDataJPA之Hibernate加载过程.html">
            
                <a href="../SpringDataJpa高级用法补充/SpringDataJPA之Hibernate加载过程.html">
            
                    
                    SpringDataJPA之Hibernate加载过程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../SpringDataJpa高级用法补充/implement-equals-hashCode-why-when.html">
            
                <a href="../SpringDataJpa高级用法补充/implement-equals-hashCode-why-when.html">
            
                    
                    implement-equals,-hashCode-why,when?
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../SpringDataJpa高级用法补充/JPA中lazy-loading-doesn’t-work.html">
            
                <a href="../SpringDataJpa高级用法补充/JPA中lazy-loading-doesn’t-work.html">
            
                    
                    JPA中lazy-loading-doesn’t-work
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../SpringDataJpa高级用法补充/SpringDataJPA之Entity关联关系Lazy过程.html">
            
                <a href="../SpringDataJpa高级用法补充/SpringDataJPA之Entity关联关系Lazy过程.html">
            
                    
                    SpringDataJPA之Entity关联关系Lazy过程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="../SpringDataJpa高级用法补充/SpringDataJpa之Hibernate5.0的Entity判断Dirty的过程.html">
            
                <a href="../SpringDataJpa高级用法补充/SpringDataJpa之Hibernate5.0的Entity判断Dirty的过程.html">
            
                    
                    SpringDataJpa之Hibernate5.0的Entity判断Dirty的过程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="../SpringDataJpa高级用法补充/多线程环境下遇到的Session的更新的坑，CompletableFuture使用的坑.html">
            
                <a href="../SpringDataJpa高级用法补充/多线程环境下遇到的Session的更新的坑，CompletableFuture使用的坑.html">
            
                    
                    多线程环境下遇到的Session的更新的坑，CompletableFuture使用的坑
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >09：Auditing与@version                    </a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="&#x7B2C;09&#x8BFE;&#xFF1A;auditing-&#x4E0E;-version">&#x7B2C;09&#x8BFE;&#xFF1A;Auditing &#x4E0E; @Version</h2>
<h3 id="auditing-&#x53CA;&#x5176;&#x4E8B;&#x4EF6;&#x8BE6;&#x89E3;">Auditing &#x53CA;&#x5176;&#x4E8B;&#x4EF6;&#x8BE6;&#x89E3;</h3>
<p>Auditing &#x7FFB;&#x8BD1;&#x8FC7;&#x6765;&#x662F;&#x5BA1;&#x8BA1;&#x548C;&#x5BA1;&#x6838;&#xFF0C;Spring &#x7684;&#x4F18;&#x79C0;&#x4E4B;&#x5904;&#x5728;&#x4E8E;&#x5E2E;&#x6211;&#x4EEC;&#x60F3;&#x5230;&#x4E86;&#x5F88;&#x591A;&#x7E41;&#x7410;&#x4E8B;&#x60C5;&#x7684;&#x89E3;&#x51B3;&#x65B9;&#x6848;&#xFF0C;&#x6211;&#x4EEC;&#x5728;&#x5B9E;&#x9645;&#x7684;&#x4E1A;&#x52A1;&#x7CFB;&#x7EDF;&#x4E2D;&#xFF0C;&#x9488;&#x5BF9;&#x4E00;&#x5F20;&#x8868;&#x7684;&#x64CD;&#x4F5C;&#x5927;&#x90E8;&#x5206;&#x662F;&#x9700;&#x8981;&#x8BB0;&#x5F55;&#x8C01;&#x4EC0;&#x4E48;&#x65F6;&#x95F4;&#x521B;&#x5EFA;&#x7684;&#xFF0C;&#x8C01;&#x4EC0;&#x4E48;&#x65F6;&#x95F4;&#x4FEE;&#x6539;&#x7684;&#xFF0C;&#x5E76;&#x4E14;&#x80FD;&#x8BA9;&#x6211;&#x4EEC;&#x65B9;&#x4FBF;&#x7684;&#x8BB0;&#x5F55;&#x64CD;&#x4F5C;&#x65E5;&#x5FD7;&#x3002;Spring Data JPA &#x4E3A;&#x6211;&#x4EEC;&#x63D0;&#x4F9B;&#x4E86;&#x5BA1;&#x8BA1;&#x529F;&#x80FD;&#x7684;&#x67B6;&#x6784;&#x5B9E;&#x73B0;&#xFF0C;&#x63D0;&#x4F9B;&#x4E86;&#x56DB;&#x4E2A;&#x6CE8;&#x89E3;&#x4E13;&#x95E8;&#x89E3;&#x51B3;&#x8FD9;&#x4EF6;&#x4E8B;&#x60C5;&#xFF1A;</p>
<ul>
<li>@CreatedBy &#x54EA;&#x4E2A;&#x7528;&#x6237;&#x521B;&#x5EFA;&#x7684;&#x3002;</li>
<li>@CreatedDate &#x521B;&#x5EFA;&#x7684;&#x65F6;&#x95F4;&#x3002;</li>
<li>@LastModifiedBy &#x4FEE;&#x6539;&#x5B9E;&#x4F53;&#x7684;&#x7528;&#x6237;&#x3002;</li>
<li>@LastModifiedDate &#x6700;&#x540E;&#x4E00;&#x6B21;&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#x3002;</li>
</ul>
<h4 id="auditing-&#x5982;&#x4F55;&#x914D;&#x7F6E;">Auditing &#x5982;&#x4F55;&#x914D;&#x7F6E;</h4>
<p>&#x6211;&#x4EEC;&#x4EE5;&#x4E00;&#x4E2A;&#x5FEB;&#x901F;&#x7684;&#x4F8B;&#x5B50;&#xFF0C;&#x770B;&#x770B;&#x5B83;&#x662F;&#x600E;&#x4E48;&#x914D;&#x7F6E;&#x751F;&#x6548;&#x7684;&#x3002;</p>
<p><strong>&#xFF08;1&#xFF09;&#x5148;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A; @Entity&#xFF1A;UserCustomerEntity &#x91CC;&#x9762;&#x7684;&#x5199;&#x6CD5;&#x5982;&#x4E0B;&#x3002;</strong></p>
<pre><code>@Entity
@Table(name = &quot;user_customer&quot;, schema = &quot;test&quot;, catalog = &quot;&quot;)
@EntityListeners(AuditingEntityListener.class)
public class UserCustomerEntity {
   @Id
   @Column(name = &quot;id&quot;, nullable = false)
@GeneratedValue(strategy = GenerationType.IDENTITY)
   private Integer id;
   @CreatedDate
   @Column(name = &quot;create_time&quot;, nullable = true)
   private Date createTime;
   @CreatedBy
   @Column(name = &quot;create_user_id&quot;, nullable = true)
   private Integer createUserId;
   @LastModifiedBy
   @Column(name = &quot;last_modified_user_id&quot;, nullable = true)
   private Integer lastModifiedUserId;
   @LastModifiedDate
   @Column(name = &quot;last_modified_time&quot;, nullable = true)
   private Date lastModifiedTime;
   @Column(name = &quot;customer_name&quot;, nullable = true, length = 50)
   private String customerName;
   @Column(name = &quot;customer_email&quot;, nullable = true, length = 50)
   private String customerEmail;
......
}
</code></pre><p>@Entity &#x5B9E;&#x4F53;&#x4E2D;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x505A;&#x4E24;&#x70B9;&#xFF1A;</p>
<ul>
<li>&#x76F8;&#x5E94;&#x7684;&#x5B57;&#x6BB5;&#x6DFB;&#x52A0; @CreatedBy&#x3001;@CreatedDate&#x3001;@LastModifiedBy and @LastModifiedDate&#x6CE8;&#x89E3;&#x3002;</li>
<li>&#x589E;&#x52A0; @EntityListeners(AuditingEntityListener.class)&#x3002;</li>
</ul>
<p><strong>&#xFF08;2&#xFF09;&#x5B9E;&#x73B0; AuditorAware &#x63A5;&#x53E3;&#x544A;&#x8BC9; JPA &#x5F53;&#x524D;&#x7684;&#x7528;&#x6237;&#x662F;&#x8C01;&#x3002;</strong></p>
<p>&#x5B9E;&#x73B0; AuditorAware &#x63A5;&#x53E3;&#xFF0C;&#x5B9E;&#x73B0; getCurrentAuditor &#x65B9;&#x6CD5;&#xFF0C;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A; Integer &#x7684; user ID&#x3002;&#x4EE5;&#x4E0B;&#x4EE3;&#x7801;&#x4ECB;&#x7ECD;&#x4E86;&#x4E24;&#x79CD;&#x505A;&#x6CD5;&#xFF1A;</p>
<pre><code>public class MyAuditorAware implements AuditorAware&lt;Integer&gt; {
   /**
    * Returns the current auditor of the application.
    * @return the current auditor
    */
   @Override
   public Integer getCurrentAuditor() {
//    &#x7B2C;&#x4E00;&#x79CD;&#x65B9;&#x5F0F;&#xFF1A;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x96C6;&#x6210;&#x4E86;spring&#x7684;Security&#xFF0C;&#x6211;&#x4EEC;&#x76F4;&#x63A5;&#x901A;&#x8FC7;&#x5982;&#x4E0B;&#x65B9;&#x6CD5;&#x5373;&#x53EF;&#x83B7;&#x5F97;&#x5F53;&#x524D;&#x8BF7;&#x6C42;&#x7684;&#x7528;&#x6237;ID.
//    Authentication authentication = 
      SecurityContextHolder.getContext().getAuthentication();
//    if (authentication == null || !authentication.isAuthenticated()) {
//       return null;
//    }
//    return ((LoginUserInfo) authentication.getPrincipal()).getUser().getId();
      //&#x7B2C;&#x4E8C;&#x79CD;&#x65B9;&#x5F0F;&#x901A;&#x8FC7;request&#x91CC;&#x9762;&#x53D6;&#x6216;&#x8005;session&#x91CC;&#x9762;&#x53D6;
      ServletRequestAttributes servletRequestAttributes =
(ServletRequestAttributes)RequestContextHolder.getRequestAttributes();
      return (Integer) servletRequestAttributes.getRequest().getSession().getAttribute(&quot;userId&quot;);
   }
}
</code></pre><p>&#x800C; AuditorAware &#x7684;&#x6E90;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code>public interface AuditorAware&lt;T&gt; {
   T getCurrentAuditor();
}
</code></pre><p>&#x901A;&#x8FC7;&#x5B9E;&#x73B0; AuditorAware &#x63A5;&#x53E3;&#x7684; getCurrentAuditor() &#x65B9;&#x6CD5;&#x544A;&#x8BC9; JPA &#x5F53;&#x524D;&#x7684;&#x7528;&#x6237;&#x662F;&#x8C01;&#xFF0C;&#x91CC;&#x9762;&#x5B9E;&#x73B0;&#x65B9;&#x6CD5;&#x5343;&#x5DEE;&#x4E07;&#x522B;&#xFF0C;&#x4F5C;&#x8005;&#x4E3E;&#x4F8B;&#x4E86;&#x4E24;&#x79CD;&#x6700;&#x5E38;&#x89C1;&#x7684;&#xFF1A;   </p>
<ul>
<li>&#x901A;&#x8FC7; Security &#x53D6;&#x3002;</li>
<li>&#x901A;&#x8FC7; Request &#x53D6;&#x3002;</li>
</ul>
<p><strong>&#xFF08;3&#xFF09;&#x901A;&#x8FC7; @EnableJpaAuditing &#x6CE8;&#x89E3;&#x5F00;&#x542F; JPA &#x7684; Auditing &#x529F;&#x80FD;&#x3002;</strong></p>
<p>&#x5E76;&#x4E14;&#x544A;&#x8BC9;&#x5E94;&#x7528; AuditorAware &#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#x662F;&#x8C01;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x901A;&#x8FC7; @Bean &#x6CE8;&#x89E3;&#x628A;&#x4E0A;&#x9762;&#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#x653E;&#x5230; Spring &#x7684; Bean &#x7BA1;&#x7406;&#x91CC;&#x9762;&#xFF0C;&#x5F53;&#x7136;&#x4E86;&#x4E5F;&#x53EF;&#x4EE5;&#x4E0A;&#x9762;&#x7684;&#x7C7B;&#x52A0;&#x4E0A; @Component&#x3002;&#x5177;&#x4F53;&#x914D;&#x7F6E;&#x65B9;&#x5F0F;&#x5982;&#x4E0B;&#xFF1A;  </p>
<pre><code>@SpringBootApplication
@EnableJpaAuditing
public class QuickStartApplication {
   public static void main(String[] args) {
      SpringApplication.run(QuickStartApplication.class, args);
   }
   @Bean
   public AuditorAware&lt;Integer&gt; auditorProvider() {
      return new MyAuditorAwareImpl();
   }
}
</code></pre><p><strong>&#x9A8C;&#x8BC1;&#x7ED3;&#x679C;&#x5982;&#x4E0B;&#x3002;</strong></p>
<p>&#x901A;&#x8FC7;&#x4EE5;&#x4E0A;&#x7684;&#x4E09;&#x6B65;&#xFF0C;&#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x5B8C;&#x6210;&#x4E86; auting &#x7684;&#x914D;&#x7F6E;&#xFF0C;&#x901A;&#x8FC7; userCustomerRepository.save(new UserCustomerEntity(&quot;1&quot;,&quot;Jack&quot;)); &#x7684;&#x6267;&#x884C;&#xFF0C;&#x6211;&#x4EEC;&#x770B;&#x6570;&#x636E;&#x5E93;&#x91CC;&#x9762;&#x7684; 4 &#x4E2A;&#x5B57;&#x6BB5;&#x5DF2;&#x7ECF;&#x7ED9;&#x586B;&#x4E0A;&#x53BB;&#x4E86;&#x3002;</p>
<h4 id="mappedsuperclass">@MappedSuperclass</h4>
<p>&#x5B9E;&#x9645;&#x5DE5;&#x4F5C;&#x4E2D;&#x6211;&#x4EEC;&#x8FD8;&#x4F1A;&#x5BF9;&#x4E0A;&#x9762;&#x7684;&#x5B9E;&#x4F53;&#x90E8;&#x5206;&#x8FDB;&#x884C;&#x6539;&#x8FDB;&#xFF0C;&#x5F15;&#x5165; @MappedSuperclass &#x6CE8;&#x89E3;&#xFF0C;&#x6211;&#x4EEC;&#x5C06; @Id&#x3001;@CreatedBy&#x3001;@CreatedDate&#x3001;@LastModifiedBy and @LastModifiedDate &#x62BD;&#x8C61;&#x5230;&#x4E00;&#x4E2A;&#x516C;&#x7528;&#x7684;&#x57FA;&#x7C7B;&#x91CC;&#x9762;&#xFF0C;&#x65B9;&#x4FBF;&#x516C;&#x7528;&#x548C;&#x5F62;&#x6210;&#x6BCF;&#x4E2A;&#x8868;&#x7684;&#x5B57;&#x6BB5;&#x7EA6;&#x675F;&#x3002;&#x53EF;&#x4EE5;&#x5C06;&#x5176;&#x653E;&#x5230;&#x6211;&#x4EEC;&#x516C;&#x53F8;&#x7684;&#x6846;&#x67B6;&#x4EE3;&#x7801;&#x4E0A;&#xFF0C;&#x5BF9;&#x8868;&#x8BBE;&#x8BA1;&#x5F62;&#x6210;&#x7EDF;&#x4E00;&#x7684;&#x5F3A;&#x7EA6;&#x675F;&#x3002;    </p>
<p><strong>&#x6B65;&#x9AA4;&#x5982;&#x4E0B;&#xFF1A;</strong></p>
<p><strong>&#xFF08;1&#xFF09;&#x6539;&#x8FDB;&#x540E;&#x6211;&#x4EEC;&#x65B0;&#x589E;&#x4E00;&#x4E2A; AbstractAuditable &#x7684;&#x62BD;&#x8C61;&#x7C7B;&#xFF1A;</strong></p>
<pre><code>@MappedSuperclass
@EntityListeners(AuditingEntityListener.class)
public abstract class AbstractAuditable {
   @Id
   @Column(name = &quot;id&quot;, nullable = false)
   @GeneratedValue(strategy = GenerationType.IDENTITY)
   private Integer id;
   @CreatedDate
   @Column(name = &quot;create_time&quot;, nullable = true)
   private Date createTime;
   @CreatedBy
   @Column(name = &quot;create_user_id&quot;, nullable = true)
   private Integer createUserId;
   @LastModifiedBy
   @Column(name = &quot;last_modified_user_id&quot;, nullable = true)
   private Integer lastModifiedUserId;
   @LastModifiedDate
   @Column(name = &quot;last_modified_time&quot;, nullable = true)
   private Date lastModifiedTime;
......
}
</code></pre><p><strong>&#xFF08;2&#xFF09;&#x800C;&#x6211;&#x4EEC;&#x6BCF;&#x4E2A;&#x9700;&#x8981; Auditing &#x7684;&#x5B9E;&#x4F53;&#x53EA;&#x9700;&#x8981;&#x7EE7;&#x627F; AbstractAuditable &#x5373;&#x53EF;&#x3002;</strong></p>
<p>&#x5185;&#x5BB9;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code>@Entity
@Table(name = &quot;user_customer&quot;, schema = &quot;test&quot;, catalog = &quot;&quot;)
public class UserCustomerEntity extends AbstractAuditable {
   @Column(name = &quot;customer_name&quot;, nullable = true, length = 50)
   private String customerName;
   @Column(name = &quot;customer_email&quot;, nullable = true, length = 50)
   private String customerEmail;
......}
</code></pre><h4 id="auditing-&#x539F;&#x7406;&#x89E3;&#x6790;">Auditing &#x539F;&#x7406;&#x89E3;&#x6790;</h4>
<p><strong>&#xFF08;1&#xFF09;&#x6211;&#x4EEC;&#x5148;&#x770B;&#x4E00;&#x4E0B;&#x5173;&#x952E;&#x7684;&#x51E0;&#x4E2A;&#x6E90;&#x7801;&#x7684;&#x5173;&#x7CFB;&#x56FE;&#xFF1A;</strong></p>
<p><img src="http://images.gitbook.cn/8cfa5800-4186-11e8-94d7-4b37be7eacf0" alt="enter image description here">  </p>
<p><strong>&#xFF08;2&#xFF09;AuditingEntityListener &#x7684;&#x6E90;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</strong></p>
<pre><code>@Configurable
public class AuditingEntityListener {
   private ObjectFactory&lt;AuditingHandler&gt; handler;
   public void setAuditingHandler(ObjectFactory&lt;AuditingHandler&gt; auditingHandler) {
      Assert.notNull(auditingHandler, &quot;AuditingHandler must not be null!&quot;);
      this.handler = auditingHandler;
   }
   //&#x5728;&#x65B0;&#x589E;&#x4E4B;&#x524D;&#x901A;&#x8FC7;handler&#x6765;&#x5F80;&#x6211;&#x4EEC;&#x7684;@Entity&#x91CC;&#x9762;&#x7684;auditor&#x7684;&#x90A3;&#x4E9B;&#x5B57;&#x6BB5;&#x585E;&#x503C;&#x3002;
   @PrePersist
   public void touchForCreate(Object target) {
      if (handler != null) {
         handler.getObject().markCreated(target);
      }
   }
   //&#x5728;&#x66F4;&#x65B0;&#x4E4B;&#x524D;&#x901A;&#x8FC7;handler&#x6765;&#x5F80;&#x6211;&#x4EEC;&#x7684;@Entity&#x91CC;&#x9762;&#x7684;auditor&#x7684;&#x90A3;&#x4E9B;&#x5B57;&#x6BB5;&#x585E;&#x503C;&#x3002;
   @PreUpdate
   public void touchForUpdate(Object target) {
      if (handler != null) {
         handler.getObject().markModified(target);
      }
   }
}
</code></pre><p><strong>&#xFF08;3&#xFF09;&#x901A;&#x8FC7;&#x8C03;&#x7528;&#x5173;&#x7CFB;&#x56FE;&#x548C; AuditingEntityListener&#xFF0C;&#x6211;&#x4EEC;&#x5176;&#x5B9E;&#x53EF;&#x4EE5;&#x53D1;&#x73B0;&#x4EE5;&#x4E0B;&#x4E24;&#x70B9;&#x60C5;&#x51B5;&#xFF1A;</strong></p>
<ul>
<li>AuditingEntityListener &#x901A;&#x8FC7;&#x59D4;&#x6258;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#xFF0C;&#x59D4;&#x6258; AuditingHandler &#x8FDB;&#x884C;&#x5904;&#x7406;&#xFF0C;&#x800C;&#x6211;&#x4EEC;&#x770B; AuditingHandler &#x7684;&#x6E90;&#x7801;&#x4F1A;&#x53D1;&#x73B0;&#xFF0C;&#x91CC;&#x9762;&#x5C31;&#x662F;&#x6839;&#x636E; ID &#x548C; Version&#xFF08;&#x540E;&#x9762;&#x4ECB;&#x7ECD;&#xFF09;&#x6765;&#x5224;&#x65AD;&#x6211;&#x4EEC;&#x7684;&#x5BF9;&#x8C61;&#x662F;&#x65B0;&#x589E;&#x8FD8;&#x662F;&#x66F4;&#x65B0;&#xFF0C;&#x4ECE;&#x800C;&#x6765;&#x66F4;&#x6539;&#x65F6;&#x95F4;&#x5B57;&#x6BB5;&#x548C; User &#x5B57;&#x6BB5;&#x3002;&#x800C; User &#x5B57;&#x6BB5;&#x662F;&#x901A;&#x8FC7; AuditorAware &#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#x6765;&#x53D6;&#x7684;&#xFF0C;&#x5E76;&#x4E14; AuditorAware &#x6CA1;&#x6709;&#x9ED8;&#x8BA4;&#x5B9E;&#x73B0;&#x7C7B;&#xFF0C;&#x53EA;&#x6709;&#x6211;&#x4EEC;&#x81EA;&#x5DF1;&#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#xFF0C;<strong>&#x4E5F;&#x5C31;&#x662F; AuditorAware &#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#x5FC5;&#x987B;&#x6211;&#x4EEC;&#x81EA;&#x5DF1;&#x6765;&#x5B9A;&#x4E49;&#xFF0C;&#x5426;&#x5219;&#x542F;&#x52A8;&#x4F1A;&#x62A5;&#x9519;</strong>&#x3002;</li>
<li>AuditingEntityListener &#x7684;&#x4EE3;&#x7801;&#x5982;&#x6B64;&#x7B80;&#x5355;&#xFF0C;&#x6211;&#x4EEC;&#x80FD;&#x4E0D;&#x80FD;&#x81EA;&#x5B9A;&#x4E49;&#x5462;&#xFF1F;&#x7B54;&#x6848;&#x662F;&#x80AF;&#x5B9A;&#x7684;&#xFF0C;&#x901A;&#x8FC7; @PrePersist&#x3001;@PreUpdate &#x67E5;&#x770B;&#x6E90;&#x7801;&#x5F97;&#x51FA;&#xFF0C;Java Persistence API &#x5E95;&#x5C42;&#x53C8;&#x5E2E;&#x6211;&#x4EEC;&#x63D0;&#x4F9B;&#x7684; Callbacks&#xFF0C;&#x800C;&#x8FD9;&#x4E9B;&#x56DE;&#x8C03;&#x65B9;&#x6CD5;&#xFF0C;&#x7528;&#x4E8E;&#x4FA6;&#x542C;&#x4FDD;&#x5B58;&#x3001;&#x67E5;&#x8BE2;&#xFF08;&#x6293;&#x53D6;&#xFF09;&#x3001;&#x66F4;&#x65B0;&#x548C;&#x5220;&#x9664;&#x6570;&#x636E;&#x5E93;&#x4E2D;&#x7684;&#x6570;&#x636E;&#x3002;&#x6CE8;&#x89E3;&#x65B9;&#x5F0F;&#x5982;&#x4E0B;&#xFF1A;</li>
</ul>
<table>
<thead>
<tr>
<th>Type</th>
<th>Description</th>
<th>&#x4E00;&#x53E5;&#x8BDD;&#x63CF;&#x8FF0;</th>
</tr>
</thead>
<tbody>
<tr>
<td>@PrePersist</td>
<td>Executed before the entity manager persist operation is actually executed or cascaded. This call is synchronous with the persist operation.</td>
<td>&#x65B0;&#x589E;&#x4E4B;&#x524D;</td>
</tr>
<tr>
<td>@PreRemove</td>
<td>Executed before the entity manager remove operation is actually executed or cascaded. This call is synchronous with the remove operation.</td>
<td>&#x5220;&#x9664;&#x4E4B;&#x524D;</td>
</tr>
<tr>
<td>@PostPersist</td>
<td>Executed after the entity manager persist operation is actually executed or cascaded. This call is invoked after the database INSERT is executed.</td>
<td>&#x65B0;&#x589E;&#x4E4B;&#x540E;</td>
</tr>
<tr>
<td>@PostRemove</td>
<td>Executed after the entity manager remove operation is actually executed or cascaded. This call is synchronous with the remove operation.</td>
<td>&#x5220;&#x9664;&#x4E4B;&#x540E;</td>
</tr>
<tr>
<td>@PreUpdate</td>
<td>Executed before the database UPDATE operation.</td>
<td>&#x66F4;&#x65B0;&#x4E4B;&#x524D;</td>
</tr>
<tr>
<td>@PostUpdate</td>
<td>Executed after the database UPDATE operation.</td>
<td>&#x66F4;&#x65B0;&#x4E4B;&#x540E;</td>
</tr>
<tr>
<td>@PostLoad</td>
<td>Executed after an entity has been loaded into the current persistence context or an entity has been refreshed.</td>
<td>&#x52A0;&#x8F7D;&#x4E4B;&#x540E;</td>
</tr>
</tbody>
</table>
<blockquote>
<p>&#x6CE8;&#x610F;&#xFF1A;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x90FD;&#x662F;&#x540C;&#x6B65;&#x673A;&#x5236;&#xFF0C;&#x4E00;&#x4F46;&#x62A5;&#x9519;&#x5C06;&#x4F1A;&#x5F71;&#x54CD;&#x6240;&#x6709;&#x5E95;&#x5C42;&#x4EE3;&#x7801;&#x6267;&#x884C;&#x3002;&#x5728;&#x5B9E;&#x9645;&#x5DE5;&#x4F5C;&#x4E2D;&#x5B9E;&#x73B0;&#x8FD9;&#x4E9B;&#x65B9;&#x6CD5;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x65B9;&#x6CD5;&#x4F53;&#x91CC;&#x9762;&#x5F00;&#x542F;&#x5F02;&#x6B65;&#x7EBF;&#x7A0B;&#xFF0C;&#x6216;&#x8005;&#x6D88;&#x606F;&#x961F;&#x5217;&#xFF0C;&#x6765;&#x5F02;&#x6B65;&#x5904;&#x7406;&#x65E5;&#x5FD7;&#xFF0C;&#x6216;&#x8005;&#x66F4;&#x7E41;&#x91CD;&#x7684;&#x5DE5;&#x4F5C;&#x3002;</p>
</blockquote>
<h4 id="listener-&#x4E8B;&#x4EF6;&#x7684;&#x6269;&#x5C55;">Listener &#x4E8B;&#x4EF6;&#x7684;&#x6269;&#x5C55;</h4>
<h5 id="&#x81EA;&#x5B9A;&#x4E49;-entitylistener">&#x81EA;&#x5B9A;&#x4E49; EntityListener</h5>
<p>&#x968F;&#x7740; DDD &#x7684;&#x8BBE;&#x8BA1;&#x6A21;&#x5F0F;&#x9010;&#x6E10;&#x88AB;&#x5927;&#x5BB6;&#x8BA4;&#x53EF;&#x548C;&#x70ED;&#x6367;&#xFF0C;JPA &#x901A;&#x8FC7;&#x8FD9;&#x79CD; Listener &#x8FD9;&#x79CD;&#x673A;&#x5236;&#x53EF;&#x4EE5;&#x5F88;&#x597D;&#x7684;&#x5B9E;&#x73B0;&#x4E8B;&#x4EF6;&#x5206;&#x79BB;&#x3001;&#x72B6;&#x4F53;&#x5206;&#x79BB;&#x3002;&#x5047;&#x5982;&#xFF0C;&#x8BA2;&#x5355;&#x7684;&#x72B6;&#x6001;&#x53D8;&#x5316;&#x53EF;&#x80FD;&#x5BF9;&#x6211;&#x4EEC;&#x6765;&#x8BF4;&#x6BD4;&#x8F83;&#x91CD;&#x8981;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5B9A;&#x4E00;&#x4E2A;&#x7C7B;&#x53BB;&#x76D1;&#x542C;&#x8BA2;&#x5355;&#x72B6;&#x6001;&#x53D8;&#x66F4;&#xFF0C;&#x901A;&#x77E5;&#x76F8;&#x5E94;&#x7684;&#x903B;&#x8F91;&#x4EE3;&#x7801;&#x5404;&#x81EA;&#x53BB;&#x5E72;&#x5404;&#x81EA;&#x7684;&#x6D3B;&#x3002;    </p>
<p><strong>&#xFF08;1&#xFF09;&#x65B0;&#x589E;&#x4E00;&#x4E2A; OrderStatusAuditListener &#x7C7B;&#xFF0C;&#x5728;&#x76F8;&#x5E94;&#x7684;&#x64CD;&#x4F5C;&#x4E0A;&#x6DFB;&#x52A0; Callbacks &#x6CE8;&#x89E3;&#x3002;</strong></p>
<pre><code>public class OrderStatusAuditListener {
   @PostPersist
   private void postPersist(OrderEntiy entity) {
      //&#x5F53;&#x66F4;&#x65B0;&#x7684;&#x65F6;&#x5019;&#x505A;&#x4E00;&#x4E9B;&#x903B;&#x8F91;&#x5224;&#x65AD;&#xFF0C;&#x53CA;&#x5176;&#x4E8B;&#x4EF6;&#x901A;&#x77E5;&#x3002;
   }
   @PostRemove
   private void PostRemove(OrderEntiy entity) {
      //&#x5F53;&#x5220;&#x9664;&#x7684;&#x65F6;&#x5019;&#x505A;&#x4E00;&#x4E9B;&#x903B;&#x8F91;&#x5224;&#x65AD;&#x3002;
   }
   @PostUpdate 
   private void PostUpdate(OrderEntiy entity) {
      //&#x5F53;&#x66F4;&#x65B0;&#x7684;&#x65F6;&#x5019;
      // entity.getOrderStatus()&#xFF0C;&#x505A;&#x4E00;&#x4E9B;&#x903B;&#x8F91;&#x5224;&#x65AD;
   }
}
</code></pre><p><strong>&#xFF08;2&#xFF09;&#x6211;&#x4EEC;&#x7684;&#x8BA2;&#x5355;&#x5B9E;&#x4F53;&#x53D8;&#x5316;&#x5982;&#x4E0B;&#xFF1A;</strong> </p>
<pre><code>@Entity
@Table(&quot;orders&quot;)
@EntityListeners({AuditingEntityListener.class, OrderStatusAuditListener.class})
public class OrderEntity  extends AbstractAuditable{
   @Enumerated(EnumType.STRING)
   @Column(&quot;order_status&quot;)
   private OrderStatusEnum orderStatus;
  ...... 
}
</code></pre><p>&#x5373;&#x53EF;&#x5B8C;&#x6210;&#x81EA;&#x5B9A;&#x4E49; EntityListener&#x3002;</p>
<h5 id="&#x5B9E;&#x9645;&#x5DE5;&#x4F5C;&#x8BB0;&#x5F55;&#x64CD;&#x4F5C;&#x65E5;&#x5FD7;&#x7684;&#x5B9E;&#x4F8B;">&#x5B9E;&#x9645;&#x5DE5;&#x4F5C;&#x8BB0;&#x5F55;&#x64CD;&#x4F5C;&#x65E5;&#x5FD7;&#x7684;&#x5B9E;&#x4F8B;</h5>
<pre><code>public class ActionsLogsAuditListener {
   private static final Logger logger = LoggerFactory.getLogger(ActionsLogsAuditListener.class);
   @PostLoad
   private void postLoad(Object entity) {
      this.notice(entity, OperateType.load);
   }
   @PostPersist
   private void postPersist(Object entity) {
      this.notice(entity, OperateType.create);
   }
   @PostRemove
   private void PostRemove(Object entity) {
      this.notice(entity, OperateType.remove);
   }
   @PostUpdate
   private void PostUpdate(Object entity) {
      this.notice(entity, OperateType.update);
   }
   private void notice(Object entity, OperateType type) {
      logger.info(&quot;{} &#x6267;&#x884C;&#x4E86; {} &#x64CD;&#x4F5C;&quot;, entity, type.getDescription());
      //&#x6211;&#x4EEC;&#x901A;&#x8FC7;active mq &#x5F02;&#x6B65;&#x53D1;&#x51FA;&#x6D88;&#x606F;&#x5904;&#x7406;&#x4E8B;&#x4EF6;
      ActiveMqEventManager.notice(new ActiveMqEvent(type, entity));
   }
   enum OperateType {
      create(&quot;&#x521B;&#x5EFA;&quot;), remove(&quot;&#x5220;&#x9664;&quot;),update(&quot;&#x4FEE;&#x6539;&quot;),load(&quot;&#x67E5;&#x8BE2;&quot;);
      private final String description;
      OperateType(String description) {
         this.description=description;
      }
      public String getDescription() {
         return description;
      }
   }
}
</code></pre><p>&#x6211;&#x4EEC;&#x901A;&#x8FC7;&#x81EA;&#x5B9A;&#x4E49;&#x7684; ActionsLogsAuditListener &#x6765;&#x76D1;&#x542C;&#x6211;&#x4EEC;&#x8981;&#x5904;&#x7406;&#x65E5;&#x5FD7;&#x7684;&#x5B9E;&#x4F53;&#xFF0C;&#x7136;&#x540E;&#x5C06;&#x4E8B;&#x4EF6;&#x53D8;&#x66F4;&#xFF0C;&#x901A;&#x8FC7;&#x6D88;&#x606F;&#x961F;&#x5217;&#x8FDB;&#x884C;&#x5F02;&#x6B65;&#x5904;&#x7406;&#xFF0C;&#x8FD9;&#x6837;&#x5C31;&#x53EF;&#x4EE5;&#x5B8C;&#x5168;&#x89E3;&#x8026;&#x4E86;&#x3002;&#x5F53;&#x7136;&#x4E86;&#xFF0C;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x89E3;&#x8026;&#x7684;&#x65B9;&#x5F0F;&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7; Spring &#x7684;&#x4E8B;&#x4EF6;&#x673A;&#x5236;&#x8FDB;&#x884C;&#x89E3;&#x51B3;&#x3002;&#x901A;&#x8FC7;&#x5DE5;&#x4F5C;&#x4E2D;&#x7684;&#x6B64;&#x793A;&#x4F8B;&#xFF0C;&#x6765;&#x5E2E;&#x52A9;&#x5927;&#x5BB6;&#x66F4;&#x597D;&#x7684;&#x7406;&#x89E3; Audit &#x7684;&#x673A;&#x5236;&#xFF0C;&#x987A;&#x4FBF;&#x8BF4;&#x4E00;&#x4E0B;&#x5904;&#x7406;&#x64CD;&#x4F5C;&#x7684;&#x65E5;&#x5FD7;&#x7684;&#x6B63;&#x786E;&#x601D;&#x8DEF;&#xFF0C;&#x8BB0;&#x5F55;&#x5F53;&#x524D;&#x771F;&#x5B9E;&#x53D1;&#x751F;&#x7684;&#x6570;&#x636E;&#x548C;&#x72B6;&#x6001;&#xFF0C;&#x53CA;&#x5176;&#x65F6;&#x95F4;&#x5373;&#x53EF;&#xFF0C;&#x5177;&#x4F53;&#x53D8;&#x5316;&#x4E86;&#x4EC0;&#x4E48;&#x90A3;&#x662F;&#x5728;&#x4E1A;&#x52A1;&#x5C55;&#x793A;&#x5C42;&#x9762;&#x4E0A;&#x8981;&#x505A;&#x7684;&#x4E8B;&#x60C5;&#xFF0C;&#x8FD9;&#x91CC;&#x6CA1;&#x6709;&#x5FC5;&#x8981;&#x505A;&#x6BD4;&#x5BF9;&#x7684;&#x4E8B;&#x60C5;&#xFF0C;&#x8BB0;&#x4F4F;&#x8FD9;&#x4E00;&#x70B9;&#x4E4B;&#x540E;&#x5C31;&#x4F1A;&#x8BA9;&#x4F60;&#x7684;&#x65E5;&#x5FD7;&#x5904;&#x7406;&#x5B9E;&#x73B0;&#x673A;&#x5236;&#x8C41;&#x7136;&#x660E;&#x6717;&#xFF0C;&#x53D8;&#x5F97;&#x5BB9;&#x6613;&#x8BB8;&#x591A;&#x3002;</p>
<h3 id="version-&#x5904;&#x7406;&#x4E50;&#x89C2;&#x9501;&#x7684;&#x95EE;&#x9898;">@Version &#x5904;&#x7406;&#x4E50;&#x89C2;&#x9501;&#x7684;&#x95EE;&#x9898;</h3>
<h4 id="version-&#x4E50;&#x89C2;&#x9501;&#x4ECB;&#x7ECD;">@Version &#x4E50;&#x89C2;&#x9501;&#x4ECB;&#x7ECD;</h4>
<p>&#x6211;&#x4EEC;&#x5728;&#x7814;&#x7A76; Auditing &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x53D1;&#x73B0;&#x4E86;&#x4E00;&#x4E2A;&#x6709;&#x8DA3;&#x7684;&#x6CE8;&#x89E3; @Version&#xFF0C;&#x6E90;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code>package org.springframework.data.annotation;
/**
 * Demarcates a property to be used as version field to implement optimistic locking on entities.
 */
@Retention(RUNTIME)
@Target(value = { FIELD, METHOD, ANNOTATION_TYPE })
public @interface Version {}
</code></pre><blockquote>
<p>&#x53D1;&#x73B0;&#x5B83;&#x5E2E;&#x6211;&#x4EEC;&#x5904;&#x7406;&#x4E86;&#x4E50;&#x89C2;&#x9501;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x4EC0;&#x4E48;&#x662F;&#x4E50;&#x89C2;&#x9501;&#xFF0C;&#x8FD8;&#x6709;&#x7EBF;&#x7A0B;&#x7684;&#x5B89;&#x5168;&#x6027;&#xFF0C;&#x5728;&#x53E6;&#x5916;&#x4E00;&#x672C;&#x4E66;<a href="https://item.jd.com/11737525.html" target="_blank">&#x300A;Java &#x5E76;&#x53D1;&#x7F16;&#x7A0B;&#x4ECE;&#x5165;&#x95E8;&#x5230;&#x7CBE;&#x901A;&#x300B;</a>&#x91CC;&#x9762;&#xFF0C;&#x6216;&#x8005;&#x770B;&#x4F5C;&#x8005;&#x7684;&#x53E6;&#x5916;&#x4E00;&#x7BC7; Chat&#xFF1A;<a href="http://gitbook.cn/m/mazi/activity/5a018ce76e62f07c64f84556" target="_blank">Java &#x591A;&#x7EBF;&#x7A0B;&#x4E0E;&#x5E76;&#x53D1;&#x7F16;&#x7A0B; &#xB7; Java &#x5DE5;&#x7A0B;&#x5E08;&#x5FC5;&#x77E5;&#x5FC5;&#x4F1A;</a>&#xFF0C;&#x4F5C;&#x8005;&#x505A;&#x4E86;&#x6DF1;&#x5165;&#x7684;&#x63A2;&#x8BA8;&#x3002;</p>
</blockquote>
<p>&#x5BF9;&#x4E8E;&#x6570;&#x636E;&#x6765;&#x8BF4;&#xFF0C;&#x7B80;&#x5355;&#x7406;&#x89E3;&#xFF1A;&#x5728;&#x6570;&#x636E;&#x5E93;&#x5E76;&#x53D1;&#x64CD;&#x4F5C;&#x65F6;&#xFF0C;&#x4E3A;&#x4E86;&#x4FDD;&#x8BC1;&#x6570;&#x636E;&#x7684;&#x6B63;&#x786E;&#x6027;&#xFF0C;&#x6211;&#x4EEC;&#x4F1A;&#x505A;&#x4E00;&#x4E9B;&#x5E76;&#x53D1;&#x5904;&#x7406;&#xFF0C;&#x4E3B;&#x8981;&#x5C31;&#x662F;&#x52A0;&#x9501;&#x3002;&#x5728;&#x52A0;&#x9501;&#x7684;&#x9009;&#x62E9;&#x4E0A;&#xFF0C;&#x5E38;&#x89C1;&#x6709;&#x4E24;&#x79CD;&#x65B9;&#x5F0F;&#xFF1A;&#x60B2;&#x89C2;&#x9501;&#x548C;&#x4E50;&#x89C2;&#x9501;&#x3002;     </p>
<ul>
<li><strong>&#x60B2;&#x89C2;&#x9501;</strong>&#xFF1A;&#x7B80;&#x5355;&#x7684;&#x7406;&#x89E3;&#x5C31;&#x662F;&#x628A;&#x9700;&#x8981;&#x7684;&#x6570;&#x636E;&#x5168;&#x90E8;&#x52A0;&#x9501;&#xFF0C;&#x5728;&#x4E8B;&#x52A1;&#x63D0;&#x4EA4;&#x4E4B;&#x524D;&#xFF0C;&#x8FD9;&#x4E9B;&#x6570;&#x636E;&#x5168;&#x90E8;&#x4E0D;&#x53EF;&#x8BFB;&#x53D6;&#x548C;&#x4FEE;&#x6539;&#x3002;</li>
<li><strong>&#x4E50;&#x89C2;&#x9501;</strong>&#xFF1A;&#x4F7F;&#x7528;&#x5BF9;&#x5355;&#x6761;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x7248;&#x672C;&#x6821;&#x9A8C;&#x548C;&#x6BD4;&#x8F83;&#xFF0C;&#x6765;&#x5BF9;&#x4FDD;&#x8BC1;&#x672C;&#x6B21;&#x7684;&#x66F4;&#x65B0;&#x662F;&#x6700;&#x65B0;&#x7684;&#xFF0C;&#x5426;&#x5219;&#x5C31;&#x5931;&#x8D25;&#xFF0C;&#x6548;&#x7387;&#x8981;&#x9AD8;&#x5F88;&#x591A;&#x3002;&#x5728;&#x5B9E;&#x9645;&#x5DE5;&#x4F5C;&#x4E2D;&#xFF0C;&#x4E50;&#x89C2;&#x9501;&#x4E0D;&#x6B62;&#x5728;&#x6570;&#x636E;&#x5E93;&#x5C42;&#x9762;&#xFF0C;&#x5176;&#x5B9E;&#x6211;&#x4EEC;&#x5728;&#x505A;&#x5206;&#x5E03;&#x5F0F;&#x7CFB;&#x7EDF;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4E3A;&#x4E86;&#x5B9E;&#x73B0;&#x5206;&#x5E03;&#x5F0F;&#x7CFB;&#x7EDF;&#x7684;&#x6570;&#x636E;&#x4E00;&#x81F4;&#x6027;&#xFF0C;&#x5206;&#x5E03;&#x5F0F;&#x4E8B;&#x7269;&#x7684;&#x4E00;&#x79CD;&#x505A;&#x6CD5;&#x5C31;&#x662F;&#x4E50;&#x89C2;&#x9501;&#x3002; </li>
</ul>
<h4 id="&#x6570;&#x636E;&#x5E93;&#x64CD;&#x4F5C;&#x4E3E;&#x4F8B;&#x8BF4;&#x660E;">&#x6570;&#x636E;&#x5E93;&#x64CD;&#x4F5C;&#x4E3E;&#x4F8B;&#x8BF4;&#x660E;</h4>
<p><strong>&#x60B2;&#x89C2;&#x9501;&#x7684;&#x505A;&#x6CD5;&#xFF1A;</strong></p>
<pre><code>select * from user where id=1 for update;
update user  set name=&apos;jack&apos;  where id=1;
</code></pre><p>&#x901A;&#x8FC7;&#x4F7F;&#x7528; for update &#x7ED9;&#x8FD9;&#x6761;&#x8BED;&#x53E5;&#x52A0;&#x9501;&#xFF0C;&#x5982;&#x679C;&#x4E8B;&#x52A1;&#x6CA1;&#x6709;&#x63D0;&#x4EA4;&#xFF0C;&#x5176;&#x4ED6;&#x4EFB;&#x4F55;&#x8BFB;&#x53D6;&#x548C;&#x4FEE;&#x6539;&#xFF0C;&#x90FD;&#x5F97;&#x6392;&#x961F;&#x7B49;&#x5F85;&#x3002;&#x5728;&#x4EE3;&#x7801;&#x4E2D;&#xFF0C;&#x6211;&#x4EEC;&#x52A0;&#x4E8B;&#x52A1;&#x7684; Java &#x65B9;&#x6CD5;&#x5C31;&#x4F1A;&#x81EA;&#x7136;&#x7684;&#x5F62;&#x6210;&#x4E86;&#x4E00;&#x4E2A;&#x9501;&#x3002;</p>
<p><strong>&#x4E50;&#x89C2;&#x9501;&#x7684;&#x505A;&#x6CD5;&#xFF1A;</strong></p>
<pre><code>select uid,name,version from user where id=1;
update user set name=&apos;jack&apos;, version=version+1 where id=1 and version=1
</code></pre><p>&#x5047;&#x8BBE;&#x672C;&#x6B21;&#x67E5;&#x8BE2; version=1&#xFF0C;&#x5728;&#x66F4;&#x65B0;&#x64CD;&#x4F5C;&#x65F6;&#xFF0C;&#x5E26;&#x4E0A;&#x8FD9;&#x6B21;&#x67E5;&#x51FA;&#x6765;&#x7684; Version&#xFF0C;&#x8FD9;&#x6837;&#x53EA;&#x6709;&#x548C;&#x6211;&#x4EEC;&#x4E0A;&#x6B21;&#x7248;&#x672C;&#x4E00;&#x6837;&#x7684;&#x65F6;&#x5019;&#x624D;&#x4F1A;&#x66F4;&#x65B0;&#xFF0C;&#x5C31;&#x4E0D;&#x4F1A;&#x51FA;&#x73B0;&#x4E92;&#x76F8;&#x8986;&#x76D6;&#x7684;&#x95EE;&#x9898;&#xFF0C;&#x4FDD;&#x8BC1;&#x4E86;&#x6570;&#x636E;&#x7684;&#x539F;&#x5B50;&#x6027;&#x3002;</p>
<h4 id="version-&#x7528;&#x6CD5;">@Version &#x7528;&#x6CD5;</h4>
<p>&#x5728;&#x6CA1;&#x6709; @Version &#x4E4B;&#x524D;&#xFF0C;&#x6211;&#x4EEC;&#x90FD;&#x662F;&#x81EA;&#x5DF1;&#x624B;&#x52A8;&#x7EF4;&#x62A4;&#x8FD9;&#x4E2A; Version &#x7684;&#xFF0C;&#x8FD9;&#x6837;&#x5F88;&#x6709;&#x53EF;&#x80FD;&#x505A;&#x4EC0;&#x4E48;&#x64CD;&#x4F5C;&#x7684;&#x65F6;&#x5019;&#x7ED9;&#x5FD8;&#x6389;&#x3002;&#x6216;&#x8005;&#x662F;&#x6211;&#x4EEC;&#x81EA;&#x5DF1;&#x5E95;&#x5C42;&#x505A;&#x6846;&#x67B6;&#xFF0C;&#x7528; AOP &#x7684;&#x601D;&#x8DEF;&#x505A;&#x62E6;&#x622A;&#x5E95;&#x5C42;&#x7EF4;&#x62A4;&#x8FD9;&#x4E2A; Version &#x7684;&#x503C;&#x3002;&#x800C; Spring Data JPA &#x7684; @Version &#x5C31;&#x662F;&#x901A;&#x8FC7; AOP &#x673A;&#x5236;&#xFF0C;&#x5E2E;&#x6211;&#x4EEC;&#x52A8;&#x6001;&#x7EF4;&#x62A4;&#x8FD9;&#x4E2A; Version&#xFF0C;&#x4ECE;&#x800C;&#x66F4;&#x4F18;&#x96C5;&#x7684;&#x5B9E;&#x73B0;&#x4E50;&#x89C2;&#x9501;&#x3002; </p>
<p><strong>&#xFF08;1&#xFF09;&#x5B9E;&#x4F53;&#x4E0A;&#x7684; Version &#x5B57;&#x6BB5;&#x52A0;&#x4E0A; @Version &#x6CE8;&#x89E3;&#x5373;&#x53EF;&#x3002;</strong></p>
<p>&#x6211;&#x4EEC;&#x5BF9;&#x4E0A;&#x9762;&#x7684;&#x5B9E;&#x4F53; UserCustomerEntity &#x6539;&#x8FDB;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code>@Entity
@Table(name = &quot;user_customer&quot;, schema = &quot;test&quot;, catalog = &quot;&quot;)
public class UserCustomerEntity extends AbstractAuditable {
   //&#x65B0;&#x589E;&#x63A7;&#x5236;&#x4E50;&#x89C2;&#x9501;&#x7684;&#x5B57;&#x6BB5;&#x3002;&#x5E76;&#x4E14;&#x52A0;&#x4E0A;@Version&#x6CE8;&#x89E3;
   @Version
   @Column(name = &quot;version&quot;, nullable = true)
   private Long version;
......
}
</code></pre><p><strong>&#xFF08;2&#xFF09;&#x5B9E;&#x9645;&#x8C03;&#x7528;</strong></p>
<pre><code>userCustomerRepository.save(new UserCustomerEntity(&quot;1&quot;,&quot;Jack&quot;));
UserCustomerEntity uc= userCustomerRepository.findOne(1);
uc.setCustomerName(&quot;Jack.Zhang&quot;);
userCustomerRepository.save(uc);
</code></pre><p>&#x6211;&#x4EEC;&#x4F1A;&#x53D1;&#x73B0; Insert &#x548C; Update &#x7684; SQL &#x8BED;&#x53E5;&#x90FD;&#x4F1A;&#x5E26;&#x4E0A; Version &#x7684;&#x64CD;&#x4F5C;&#x3002;&#x5F53;&#x4E50;&#x89C2;&#x9501;&#x66F4;&#x65B0;&#x5931;&#x8D25;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x629B;&#x51FA;&#x5F02;&#x5E38; org.springframework.orm.ObjectOptimisticLockingFailureException&#x3002;</p>
<h5 id="&#x5B9E;&#x73B0;&#x539F;&#x7406;&#x5173;&#x952E;&#x4EE3;&#x7801;"><strong>&#x5B9E;&#x73B0;&#x539F;&#x7406;&#x5173;&#x952E;&#x4EE3;&#x7801;</strong></h5>
<p>&#xFF08;1&#xFF09;SimpleJpaRepository.class &#x91CC;&#x9762;&#x7684; save &#x65B9;&#x6CD5;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code>public &lt;S extends T&gt; S save(S entity) {
   if (entityInformation.isNew(entity)) {
      em.persist(entity);
      return entity;
   } else {
      return em.merge(entity);
   }
}
</code></pre><p>&#xFF08;2&#xFF09;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x5728;&#x6B64;&#x5904;&#x8BBE;&#x7F6E;&#x4E00;&#x4E2A; debug &#x65AD;&#x70B9;&#x7684;&#x8BDD;&#xFF0C;&#x6211;&#x4EEC;&#x4E00;&#x6B65;&#x4E00;&#x6B65;&#x5F80;&#x4E0B;&#x9762;&#x8D70;&#x4F1A;&#x53D1;&#x73B0;&#x8FDB;&#x5165; JpaMetamodelEntityInformation.class &#x7684;&#x5173;&#x952E;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;</p>
<pre><code>    @Override
    public boolean isNew(T entity) {
        if (!versionAttribute.isPresent()
                || versionAttribute.map(Attribute::getJavaType).map(Class::isPrimitive).orElse(false)) {
            return super.isNew(entity);
        }
        BeanWrapper wrapper = new DirectFieldAccessFallbackBeanWrapper(entity);
        return versionAttribute.map(it -&gt; wrapper.getPropertyValue(it.getName()) == null).orElse(true);
    }
</code></pre><p>&#x6240;&#x4EE5;&#x5230;&#x8FD9;&#x91CC;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x5F53;&#x6211;&#x4EEC;&#x66F4;&#x65B0;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x82E5;&#x5B9E;&#x4F53;&#x5BF9;&#x8C61;&#x4E0A;&#x9762;&#x6709; @Version &#x6CE8;&#x89E3;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x4E00;&#x5B9A;&#x8981;&#x5E26;&#x4E0A; version&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x5E26;&#x4E0A; version &#x5B57;&#x6BB5;&#x7684;&#x503C;&#xFF0C;&#x53EA;&#x6709; ID &#x5B57;&#x6BB5;&#x7684;&#x503C;&#xFF0C;&#x7CFB;&#x7EDF;&#x4E5F;&#x4F1A;&#x8BA4;&#x4E3A;&#x662F;&#x65B0;&#x589E;&#x3002;&#x76F8;&#x53CD;&#xFF0C;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x6CA1;&#x6709; @Version &#x6CE8;&#x89E3;&#x7684;&#x5B57;&#x6BB5;&#xFF0C;&#x90A3;&#x4E48;&#x5C31;&#x4F1A;&#x4EE5; @ID &#x5B57;&#x6BB5;&#x6765;&#x5224;&#x65AD;&#x662F;&#x5426;&#x662F;&#x65B0;&#x589E;&#x3002;&#x5176;&#x5B9E;&#x8FD9;&#x91CC;&#x6211;&#x4EEC;&#x4E5F;&#x660E;&#x767D;&#xFF0C;&#x7701;&#x53BB;&#x4E86;&#x4F20;&#x7EDF;&#x90FD;&#x9700;&#x8981;&#x6211;&#x4EEC;&#x81EA;&#x5DF1;&#x53BB;&#x5B9E;&#x73B0;&#x7684; saveOrUpdate &#x65B9;&#x6CD5;&#x3002;     </p>
<p>&#xFF08;3&#xFF09;&#x5176;&#x5B9E;&#x6211;&#x4EEC;&#x591A;&#x770B;&#x770B;&#x4EE3;&#x7801;&#xFF0C;&#x591A; debug &#x51E0;&#x6B21;&#x5C31;&#x4F1A;&#x53D1;&#x73B0;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x5728; @Entity &#x7684;&#x7C7B;&#x91CC;&#x9762;&#x8986;&#x76D6;&#x6389; isNew() &#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x6837;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x81EA;&#x5DF1;&#x7684; isNew &#x7684;&#x5224;&#x65AD;&#x903B;&#x8F91;&#x3002;</p>
<pre><code>@Entity
@Table(name = &quot;user&quot;)
public class UserEntity  implements Persistable {
    @Transient   //&#x8FD9;&#x4E2A;&#x6CE8;&#x89E3;&#x8868;&#x660E;&#x8FD9;&#x4E2A;&#x5B57;&#x6BB5;&#x4E0D;&#x662F;&#x6301;&#x4E45;&#x5316;&#x7684;
    @JsonIgnore //json&#x663E;&#x793A;&#x7684;&#x65F6;&#x5019;&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x5FFD;&#x7565;&#x8FD9;&#x4E2A;&#x5B57;&#x6BB5;
    @Override
    public boolean isNew() {
        return getId() == null;
    }
    ....
}
</code></pre><blockquote>
<p>&#x5176;&#x5B9E;&#xFF0C;&#x5F88;&#x591A;&#x8BFE;&#x7A0B;&#x91CC;&#x9762;&#x4F20;&#x9012;&#x4E86;&#x4E00;&#x79CD;&#x5B66;&#x4E60; Code &#x7684;&#x4E00;&#x79CD;&#x601D;&#x8DEF;&#xFF0C;&#x5927;&#x5BB6;&#x4E00;&#x5B9A;&#x8981;&#x4ED4;&#x7EC6;&#x4F53;&#x4F1A;&#xFF0C;&#x5B66;&#x4F1A;&#x9605;&#x8BFB;&#x6E90;&#x7801;&#x6765;&#x67E5;&#x627E;&#x5176;&#x4F7F;&#x7528;&#x65B9;&#x6CD5;&#x3002;&#x2014;&#x2014;&#x5F20;&#x632F;&#x534E;.Jack</p>
</blockquote>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="08.html" class="navigation navigation-prev " aria-label="Previous page: 08 :  JpaRepository扩展之自定义Repositor    ">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="10.html" class="navigation navigation-next " aria-label="Next page: 10：对MvcWeb的支持分页和排序的支持            ">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"09：Auditing与@version                    ","level":"1.2.9","depth":2,"next":{"title":"10：对MvcWeb的支持分页和排序的支持            ","level":"1.2.10","depth":2,"path":"《SpringDataJpa实战》书/10.md","ref":"./《SpringDataJpa实战》书/10.md","articles":[]},"previous":{"title":"08 :  JpaRepository扩展之自定义Repositor    ","level":"1.2.8","depth":2,"path":"《SpringDataJpa实战》书/08.md","ref":"./《SpringDataJpa实战》书/08.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["livereload"],"pluginsConfig":{"livereload":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"《SpringDataJpa实战》书/09.md","mtime":"2018-04-17T03:54:00.000Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-12-17T06:04:38.403Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

